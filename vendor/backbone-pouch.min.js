/*! backbone-pouch - v1.1.0 - 2013-07-16
* http://jo.github.io/backbone-pouch/
* Copyright (c) 2013 Johannes J. Schmidt; Licensed MIT */
(function(t){"use strict";function e(t,e){t.options=t.options||{},e.options=e.options||{},t.fetch===void 0&&(t.fetch=e.fetch),t.listen===void 0&&(t.listen=e.listen),t.db===void 0&&(t.db=e.db),o.each(e.options,function(e,n){t.options[n]=t.options[n]||{},o.extend(t.options[n],e)})}var n;n="object"==typeof exports?exports:t.BackbonePouch={};var o=t._;o||"function"!=typeof require||(o=require("underscore"));var i={create:"post",update:"put",patch:"put","delete":"remove"};n.defaults={fetch:"allDocs",listen:!0,options:{post:{},put:{},get:{},remove:{},allDocs:{include_docs:!0},query:{include_docs:!0},spatial:{include_docs:!0},changes:{continuous:!0,include_docs:!0}}},n.sync=function(t){t=t||{},e(t,n.defaults);var c=function(n,c,r){function s(t,e){return t?r.error&&r.error(t):(("create"===n||"update"===n||"patch"===n)&&(e={_id:e.id,_rev:e.rev}),"delete"===n&&(e={}),"read"===n&&(e.rows&&(e=o.map(e.rows,function(t){return t.doc||o.extend({_id:t.id},t.value)})),r.listen&&r.db.info(function(t,e){r.db.changes(o.extend({},r.options.changes,{since:e.update_seq,onChange:function(t){var e=c.get(t.id);t.deleted?e&&e.destroy():e?e.set(t.doc):c.add(t.doc),"function"==typeof r.options.changes.onChange&&r.options.changes.onChange(t)}}))})),r.success&&r.success(e))}if(r=r||{},e(r,c&&c.pouch||{}),e(r,t),"string"!=typeof n)return r;if(!r.db)throw Error('A "db" property must be specified');if(c.trigger("request",c,r.db,r),"read"===n){if(c.id)return r.db.get(c.id,r.options.get,s);if("query"===r.fetch||"spatial"===r.fetch){if(!r.options[r.fetch].fun)throw Error('A "'+r.fetch+'.fun" object must be specified');return r.db[r.fetch](r.options[r.fetch].fun,r.options[r.fetch],s)}r.db[r.fetch](r.options[r.fetch],s)}else r.db[i[n]](c.toJSON(),r.options[i[n]],s);return r};return c.defaults=t,c},n.attachments=function(t){function e(t,e){return encodeURIComponent(t)+"/"+encodeURIComponent(e)}function n(e){if(e.pouch&&e.pouch.db)return e.pouch.db;if(e.collection&&e.collection.pouch&&e.collection.pouch.db)return e.collection.pouch.db;if(t.db)return t.db;var n=e.sync();if(n.db)return n.db;throw Error('A "db" property must be specified')}return t=t||{},{attachments:function(t){var e=this.get("_attachments")||{};return t?o.filter(o.keys(e),function(n){return"function"==typeof t?t(n,e[n]):e[n].content_type.match(t)}):o.keys(e)},attachment:function(t,o){var i=n(this);return i.getAttachment(e(this.id,t),o)},attach:function(t,o,i,c){"function"==typeof o&&(c=o,o=void 0,i=void 0),"function"==typeof i&&(c=i,i=void 0),o=o||t.filename,i=i||t.type,this.id||this.set({_id:Math.uuid()},{silent:!0});var r=n(this),s=this;return r.putAttachment(e(this.id,o),this.get("_rev"),t,i,function(t,e){if(!t&&e.rev){var n=s.get("_attachments")||{};n[o]={content_type:i,stub:!0},s.set({_rev:e.rev,_attachments:n},{silent:!0})}c(t,e)})}}}})(this);