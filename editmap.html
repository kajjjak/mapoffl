<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<link href="//netdna.bootstrapcdn.com/bootswatch/2.3.1/cerulean/bootstrap.min.css" rel="stylesheet">
<title>Ævintyr á gönguför - leiðir</title>
<style>
  body {
    padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
  }
</style>

<script type="text/javascript" src="//maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="/ghostburster/_design/html/_rewrite/js/guimap.js"></script>
<script type="text/javascript">
  var directionDisplay;
  var directionsService = new google.maps.DirectionsService();
  var map;
  var origin = null;
  var destination = null;
  var directionsVisible = false;
  var path_waypoints = [];
  var index_waypoints = 0;
  var preset_paths = undefined;
  var marker_appending_enabled = true;
  map_settings = {'markers': {'draggable':true}};
  function ParseDMS(input) {
    var parts = input.split(/[^\d\w]+/);
    var lat = ConvertDMSToDD(parts[0], parts[1], parts[2], parts[3]);
    var lng = ConvertDMSToDD(parts[4], parts[5], parts[6], parts[7]);
    return [lat, lng];
  }

  function ConvertDMSToDD(days, minutes, seconds, direction) {
    var dd = parseFloat(days) + parseFloat(minutes)/60.0 + parseFloat(seconds)/(60.0*60.0);

    if (direction == "S" || direction == "W") {
        dd = dd * -1.0;
    } // Don't do anything for N or E
    return dd;
  }

  function convertLatLngDMS(){
    var latlngdms = ParseDMS($("#latlngdms").val());
    $("#lat").val(latlngdms[0]);
    $("#lng").val(latlngdms[1]);
    $("#latlngdec").val(latlngdms[0]+ ", " + latlngdms[1]);
  }
  
  function convertLatLngDec(){
    var latlngdec = $("#latlngdec").val().split(",");
    $("#lat").val(latlngdec[0]);
    $("#lng").val(latlngdec[1]);
  }
  
  function createNewMarker(){
    var lat = parseFloat($("#lat").val());
    var lng = parseFloat($("#lng").val());
    var name = $("#markerName").val();
    var descr = $("#markerDescr").val();
    var m = addMarker(lat, lng, name, descr);
  }

  function initialize() {
    directionsDisplay = new google.maps.DirectionsRenderer({'draggable': true});
    var cntr = new google.maps.LatLng(64.135026, -21.895580);
    var myOptions = {
      zoom:13,
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      center: cntr
    }
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
    directionsDisplay.setMap(map);
    directionsDisplay.setPanel(document.getElementById("directionsPanel"));
    
    google.maps.event.addListener(map, 'click', function(event) {
      var latlng = event.latLng;
      if (marker_appending_enabled){
          addMarker(latlng.lat(), latlng.lng());
      }
    });
    
    setTimeout("updateMap()", 5000);
  }

  function addMarker(lat, lng, name, descr) {
    var latlng = new google.maps.LatLng(lat, lng);
    var area = $("#area").val();
    var path = getRoutepathName();
    var mrkr = getAttributesModelDescr();
    var values = {};
    var default_values = getAttributesModelDescr();
    for (i in default_values){ 
          values[default_values[i].field] = default_values[i].default_value;
    }
    if (name === undefined){ name = ""; }
    if (descr === undefined){ descr = ""; }
    values["schema"] = "8";
    values["timestamp"] = new Date().getTime();
    values["lat"] = lat;
    values["lon"] = lng;
    values["path"] = path;
    values["area"] = area
    values["attraction"] = true;
    values["name"] = name;
    values["descr"] = descr;
    var i = itemsList.create(values);
    //i.save();
    return i;
  }
  path_section = 0;
  
  function calcRoute_NOTUSED(){
    var wpnts = [];
    path_sections = waypoints.length/8;
    for (s = 0; s < path_sections; s++){
      path_section = s;
      for (i = path_section * 8; i < (path_section * 8) + 8; i++){
        if(waypoints.length > i ){
          wpnts.push(waypoints[i]);
          destination = waypoints[i].location;
          
        }
      }
      origin = waypoints[path_section * 8].location;
      calcRouteSection(wpnts);
      console.info (getPathSection());
      alert("Section " + s);
    }
  }

  function calcRoute(path_section){
    var wpnts = [];   
    path_sections = waypoints.length/8;
    if(path_section === undefined){
      path_section = 0;
      origin = waypoints[0].location;
    } else {
      path_waypoints = path_waypoints.concat(getPathSection());
      origin = destination; //take last destination
    }
    
    if (path_section < Math.ceil(path_sections)){
      for (i = path_section * 8; i < (path_section * 8) + 8; i++){
        if(waypoints.length > i ){
          wpnts.push(waypoints[i]);
          destination = waypoints[i].location;
        }
      }
      calcRouteSection(wpnts);    
      setTimeout("calcRoute(" + (path_section + 1) + ")", 2000);
    } else { //reset for future
      path_section = undefined;
    }
    //alert("Section " + path_section);
  }


  function calcRouteSection(waypoints) {
    if (origin == null) {
      alert("Click on the map to add a start point");
      return;
    }
    
    if (destination == null) {
      alert("Click on the map to add an end point");
      return;
    }
    
    var mode;
    switch (document.getElementById("mode").value) {
      case "driving":
        mode = google.maps.DirectionsTravelMode.DRIVING;
        break;
      case "walking":
        mode = google.maps.DirectionsTravelMode.WALKING;
        break;
    }
    
    var request = {
        origin: origin,
        destination: destination,
        waypoints: waypoints,
        travelMode: mode,
        optimizeWaypoints: document.getElementById('optimize').checked,
        avoidHighways: document.getElementById('highways').checked,
        avoidTolls: true,
        unitSystem: google.maps.UnitSystem.METRIC
    };
    
    directionsService.route(request, function(response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
      }
    });
    
    // clearMarkers();
    directionsVisible = true;
  }
  
  function updateMode() {
    if (directionsVisible) {
      calcRoute();
    }
  }
  
  function reset() {
    clearMarkers();
    clearWaypoints();
    directionsDisplay.setMap(null);
    directionsDisplay.setPanel(null);
    directionsDisplay = new google.maps.DirectionsRenderer();
    directionsDisplay.setMap(map);
    directionsDisplay.setPanel(document.getElementById("directionsPanel"));    
  }
  
  function getRoutepathName(){
    return getSelectedPathName();
  }
  
  function saveRoute(){
    var area = $("#area").val();
    var path = getRoutepathName();
    itemsListView.clearByPathAndArea(path, area);
    var route = getPath();
    for (i in route){
      route[i]["attraction"] = false;
      route[i]["path"] = path;
      route[i]["area"] = area;
      console.info("Saving route " + JSON.stringify(route[i]));
      saveLocationToServer(route[i]);
    }
    path_waypoints = [];
    index_waypoints = 0;

    /*
    for (i in markers){
    attraction = {};      
      attraction["attraction"] = true;
      attraction["path"] = path;
      attraction["area"] = area;
      attraction["lat"] = markers[i].position.ib;
      attraction["lon"] = markers[i].position.jb;   
      console.info("Saving attraction " + JSON.stringify(attraction));
      saveLocationToServer(attraction);
    }
    */
  }
  
  function saveLocationToServer(l){
    l["schema"] = "8";
    itemsList.create(l);
  }

/*  function getPath(){
    var google_path = directionsDisplay.directions.routes[0].overview_path;
    var path = [];
    for (var i in google_path){
      var latlng = google_path[i];
      var descr = "";
      path.push({"lat" : latlng.hb , "lon": latlng.ib, "descr": descr});
    }
    console.info(JSON.stringify(path));
  }

*/
  function _fixInstruction(txt){
    txt = txt.replace("Turn", "Snuið");
    txt = txt.replace("onto", "að");
    txt = txt.replace("Destination will be on the left", " Áfangastaður mun vera á hægri hönd")
    txt = txt.replace("Destination will be on the right", " Áfangastaður mun vera á vinstri hönd")
    txt = txt.replace("left", "vinstri");
    txt = txt.replace("right", "hægri");
    txt = txt.replace("south", "suður");
    txt = txt.replace("north", "norður");
    txt = txt.replace("west", "vestur");
    txt = txt.replace("east", "austur");
    txt = txt.replace('<div style="font-size:0.9em">', '')
    txt = txt.replace('</div>', '')
    txt = txt.replace("straight", "beint");
    txt = txt.replace("Continue", "Haldið áfram");
    txt = txt.replace("Head", "Stefnið");
    txt = txt.replace("toward", "á moti");
    txt = txt.replace("on", "á");
    txt = txt.replace("roundabout", "hringtorg");
    
    txt = txt.replace("to stay", "til að vera á");
    txt = txt.replace("Sharp", "Skörp");
    txt = txt.replace("Make a", "Gerið");
    txt = txt.replace("at", "við");
    txt = txt.replace("U-turn", "U-beygja");
    txt = txt.replace("Slight", "Létt");
    txt = txt.replace("At the", "Við");
    txt = txt.replace("take the", "takið");
    txt = txt.replace("2nd", "önnur");
    txt = txt.replace("1st", "fyrsta");
    txt = txt.replace("3rd", "þriðja");
    txt = txt.replace("exit", "beygjið frá");
    return txt;
  }

  function getPathFromLegs(){
    var google_legs = directionsDisplay.directions.routes[0].legs;
    var path = [];
    var p = undefined;
    for (var i in google_legs){
      var google_path = google_legs[i].steps;
      for (var j in google_path){        
        var step = google_path[j];
        var instructions = _fixInstruction(step.instructions);
        var latlng = step.lat_lngs[0];
        index_waypoints = index_waypoints + 1;
        p = {"step_index": index_waypoints, "waypoint": false, "lat" : latlng.lat(), "lon": latlng.lng(), "distance-text": step.distance.text, "distance-value": step.distance.value, "duration-text": step.duration.text, "duration-value": step.duration.value, "descr": instructions, "mode":step.travel_mode};
        path.push(p);
      }
      // path.pop()
      // p.waypoint = true;
      // path.push(p);
    }
    //console.info(JSON.stringify(path));
    return path;
  }
  
  function getPath(){
    return path_waypoints;
  }
  
  function getPathSection(){
    var google_overview_path = directionsDisplay.directions.routes[0].overview_path;
    var path = [];
    var p = undefined;
    for (var i in google_overview_path){
      var latlng = google_overview_path[i];
      index_waypoints = index_waypoints + 1;
      p = {"attraction":false, "step_index": index_waypoints, "waypoint": false, "lat" : latlng.lat(), "lon": latlng.lng()};
      path.push(p);
    }
    //console.info(JSON.stringify(path));
    return path;
  }
  
  function getSelectedPathName(){
    var v = $("#path").val();
    if (v == ""){ return "yellow"; }
    else { return v };
  }
  
  function updateMap(){
    var area = $("#area").val();
    var path = getSelectedPathName();
    reset();
    itemsListView.showIconByPathAndArea(path, area)
  }


  function showByAreaAndPath(){
      var area = $("#area").val();
      var path = getSelectedPathName();
      reset();
      itemsListView.showTrailByPathAndArea(path, area)
  }

  function deleteMarkerSelected(){
    selected_marker.setMap();
    var schema_id = $("#markerId").val();
    var mdl = itemsList.get(schema_id);
    mdl.destroy();
  }

  function saveMarkerSelected(){
    var schema_id = $("#markerId").val();
    var mdl = itemsList.get(schema_id);
    var timestamp = parseInt($("#markerOrder").val());
    if (timestamp != mdl.get("timestamp")){
      setTimeout("updateMap()", 100);
    }
    mdl.set({"descr": $("#markerDescr").val()});
    mdl.set({"name": $("#markerName").val()});
    mdl.set({"content": $("#markerContent").val()});
    mdl.set({"timestamp": timestamp});
    mdl.save();
  }
  
  function showCalcRouteOptions(){
    $('#mdlPathSetting').modal('show');
  }
  
  function canAddMarkers(b){
    window.marker_appending_enabled=b;
  }

</script>

  <style>
  #sortable { list-style-type: none; margin: 0; padding: 0; width: 60%; }
  #sortable li { margin: 0 3px 3px 3px; padding: 0.4em; padding-left: 1.5em; font-size: 1.4em; height: 18px; }
  #sortable li span { position: absolute; margin-left: -1.3em; }
  </style>

</head>
<body onload="initialize()">
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" href="#">Ævintyr á gönguför</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li class="active"><a href="/ghostburster/_design/html/_rewrite/editmap.html">Gönguleiðir</a></li>
              <li><a href="/ghostburster/_design/html/_rewrite/mobile/" target="mobile">Appið</a></li>
              <li><a href="/ghostburster/_design/html/_rewrite/"  target="website">Vefsiðan</a></li>
              <li><a href="/ghostburster/_design/html/_rewrite/media/">Myndir</a></li>
              <li><a href="/ghostburster/_design/html/_rewrite/admin/">Innskráning/Útskráning</a></li>
              <li><a href="#about" onclick="$('#mdlAbout').modal('show')">Um verkefnið</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>
  <!-- Modal -->
  <div id="mdlTextEditor" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="mdlTextEditorLabel" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
      <h3 id="mdlTextEditorLabel">Ritil</h3>
    </div>
    <div class="modal-body">
      <textarea name="markerContent" id="markerContent"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" data-dismiss="modal" aria-hidden="true" onclick="saveMarkerSelected()">Vista</button><button class="btn" data-dismiss="modal" aria-hidden="true">Loka</button>
    </div>
  </div>       
  <!-- Modal -->
  <div id="mdlAbout" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="mdlAboutLabel" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
      <h3 id="mdlAboutLabel">Um verkefnið</h3>
    </div>
    <div class="modal-body">
      <p>Verkefnastjóri er Helena Óladóttir</p>
      <p>Forritað af aGameCompany ehf</p>
    </div>
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal" aria-hidden="true">Loka</button>
    </div>
  </div>       
  <!-- Modal -->
  <div id="mdlPathSetting" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="mdlPathSettingLabel" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
      <h3 id="mdlPathSettingLabel">Reikna út stystu leið</h3>
    </div>
    <div class="modal-body">
      <p>Valmöguleikar til að reikna út gönguleið</p>
      <p>
        <select id="mode" onchange="updateMode()">
          <option value="walking">Göngutur</option>
          <option value="driving">Bill</option>
        </select>
        </p>
      <label class="checkbox">
        <input type="checkbox" id="highways" checked />Forðast götur
      </label>
      <label class="checkbox">
        <input type="checkbox" id="optimize" />Styðsta leið
      </label>
    </div>
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal" aria-hidden="true">Loka</button>
      <button class="btn btn-primary" data-dismiss="modal" onclick="calcRoute()">Reikna út</button>
    </div>
  </div>   
    <div class="container">
    <div class="row">
      <div class="span12">
        <div class="span3">
        <select id="area" onchange="updateMap();">
          <option value="1" selected>Vesturbær</option>
          <option value="2">Miðborgin</option>
          <option value="3">Hlíðar</option>
          <option value="4">Laugardalur og Langholtshverfi</option>
          <option value="5">Háaleiti og Bústaðir</option>
          <option value="6">Breiðholt</option>
          <option value="7">Árbær</option>
          <option value="8">Grafavogur</option>
          <option value="9">Grafarholt og Úlfársdalur</option>
          <option value="10">Kjalarnes</option>
        </select> 
        </div>
          <div class="span3">
            <select id="path" onchange="updateMap();">
              <option value="yellow" selected>Gula leiðin</option>
              <option value="red">Rauða leiðin</option>
              <option value="green">Græna leiðin</option>
              <option value="blue">Bláa leiðin</option>
              <option value="purple">Fjólubláa leiðin</option>
              <option value="orange">Appelsinu gula leiðin</option>
            </select>
          </div>
          <div class="span3">
        <div class="btn-group">
          <a class="btn dropdown-toggle btn-primary" data-toggle="dropdown" href="#">
            Aðgerð
            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu">
            <li><a tabindex="-1" href="#" onclick="showCalcRouteOptions()">Reikna út gönguleið</a></li>
            <li><a tabindex="-1" href="#" onclick="reset()">Endurstilla</a></li>
            <li class="divider"></li>
            <li><a tabindex="-1" href="#" onclick="saveRoute()">Vista gönguleið</a></li>
          </ul>
        </div>          
          </div>
          <div class="span3">
          </div>
      </div>
    </div>
    <div class="row">
      <div class="span12">
        <div class="tabbable"> <!-- Only required for left/right tabs -->
          <ul class="nav nav-tabs">
            <li class="active"><a href="#tab1" data-toggle="tab" onclick="canAddMarkers(true);">Bæta við</a></li>
            <li><a href="#tab2" data-toggle="tab" onclick="canAddMarkers(false);">Breyta</a></li>
          </ul>
          <div class="tab-content">  
            <div class="tab-pane active" id="tab1">
              <p>Bætið við staðsetting á kortið eða fyllið út eitt af reitum fyrir neðan.</p>
            <form class="form-horizontal">
              <div class="control-group">
                <label class="control-label" for="latlngdms">DMS</label>
                <div class="controls">
                  <input type="text" name="latlngdms" id="latlngdms" onchange="convertLatLngDMS()" placeholder="Ex: 40 26′ 47″ N 079 58′ 36″ W">
                </div>
                <label class="control-label" for="latlngdec">Latitude and longditude</label>
                <div class="controls">
                  <input type="text" name="latlngdec" id="latlngdec" onchange="convertLatLngDec()" placeholder="Ex: 64.0323, -21.2313">
                </div>
              </div>
              <div class="control-group">
                <div class="controls">
                  <input type="hidden" name="lat" id="lat">
                  <input type="hidden" name="lng" id="lng">
                  <button class="btn" type="button" onclick="createNewMarker()">Bæta við staðsettning</button>
                </div>
              </div>
            </form>   
            </div>
            <div class="tab-pane" id="tab2">
              <p>Breyta valin staðsettning fyrir valin staðetting <span name="markerId" id="markerId"></span></p>
              <div class="span6">
                <form class="form-horizontal">
                  <div class="control-group">
                  <label class="control-label" for="markerName">Auðkenni</label>
                  <div class="controls">
                    <input type="text" name="markerName" id="markerName"></input>
                  </div>
                  <!--label class="control-label" for="markerDescr">Lýsing</label>
                  <div class="controls">
                    <textarea name="markerDescr" id="markerDescr"></textarea>
                  </div-->
                  <label class="control-label" for="markerOrder">Rað númer</label>
                  <div class="controls">
                    <input type="text" name="markerOrder" id="markerOrder"></input>
                    </div>
                  </div>
                <div class="control-group">
                  <div class="controls">                
                    <button class="btn" type="button" onclick="saveMarkerSelected()">Vista</button>
                    <button class="btn btn-warning" type="button" onclick="deleteMarkerSelected()">Eyða</button>
                  </div>
                </div>
              </form>
              </div>
              <div class="span3">
                <textarea name="markerDescr" id="markerDescr"></textarea>
                <span class="help-inline">Lýsing <a href="#" onclick="$('#mdlTextEditor').modal('show')">(meira)</a></span>
              </div>
            </div>
          </div>
        </div>  
      </div>
    </div>
    <div style="position:relative; border: 1px; width: 100%; height: 400px;">
      <div id="map_canvas" style="border: 1px solid black; position:absolute; left: 20%; width:80%; height:398px"></div>
      <div id="directionsPanel" style="background-color:gray; position:absolute; left: 0px; width:20%; height:400px; overflow: auto"></div>
    </div>
  </div> <!-- /container -->
  <script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
  <script type="text/javascript" src="/_utils/script/sha1.js"></script>
  <script type="text/javascript" src="/_utils/script/json2.js"></script>
  <script type="text/javascript" src="/_utils/script/jquery.couch.js"></script>
  <script type="text/javascript" src="http://cdn.agamecompany.com/vendor/backbone-couchdb/1.3/backbone-couchdb.js"></script>  
  <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>  
  <script type="text/javascript" src="/ghostburster/_design/html/_rewrite/js/path2.js"></script>
<!-- load the Aloha Editor https://gist.github.com/evo42/1448270 ->
<link rel="stylesheet" href="http://cdn.aloha-editor.org/current/css/aloha.css" type="text/css">
<script src="http://cdn.aloha-editor.org/current/lib/require.js"></script>
<script src="http://cdn.aloha-editor.org/current/lib/aloha.js"
  data-aloha-plugins="common/ui,common/format,common/highlighteditables,common/link,common/image"></script>
<script type="text/javascript">
	Aloha.ready( function() {
	    Aloha.jQuery(".editable").aloha();
		Aloha.require( ["aloha", "aloha/jquery"], function( Aloha, jQuery) {
			
			/* save all changes after leaving an editable *
			Aloha.bind("aloha-editable-deactivated", function(){
				var content = Aloha.activeEditable.getContents();
				var contentId = Aloha.activeEditable.obj[0].id;
				var pageId = window.location.pathname;
	
				if ( contentId.match(/-aloha$/gi) ) {
					contentId = contentId.replace( /-aloha/gi, "" );
				}
				saveDocument("' + doc._id + '", contentId, content);
	 		});
	 		*/
		});
	});
</script>
<-- load the Aloha Editor - ends -->	

</body>
</html>